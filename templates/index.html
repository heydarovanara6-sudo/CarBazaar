{% extends "base.html" %}

{% block content %}
{% set brand_options = [] %}
{% for car in cars %}
{% if car.brand not in brand_options %}
{% set _ = brand_options.append(car.brand) %}
{% endif %}
{% endfor %}

<section class="filters" id="filters">
    <div class="filters-header">
        <div class="filters-heading">
            <p class="filters-kicker">Smart search</p>
            <h3>Fine-tune the listings</h3>
            <p>Combine brand, price, currency and city filters to find the exact car you have in mind.</p>
        </div>
        <div class="filters-badges">
            <span class="filters-badge accent">‚ö° Instant updates</span>
            <span class="filters-badge">‚ú® Seamless experience</span>
        </div>
    </div>
    <div class="filters-grid">
        <div class="filter-group">
            <label for="brandFilter">Brand</label>
            <select id="brandFilter">
                <option value="">Any</option>
                {% for b in brand_options %}
                <option value="{{ b|lower }}">{{ b }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="priceMin">Price from</label>
            <input id="priceMin" type="number" min="0" placeholder="0">
        </div>
        <div class="filter-group">
            <label for="priceMax">Price to</label>
            <input id="priceMax" type="number" min="0" placeholder="100000">
        </div>
        <div class="filter-group">
            <label for="currencyFilter">Currency</label>
            <select id="currencyFilter">
                <option value="">Any</option>
                <option value="AZN">AZN</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="cityFilter">City</label>
            <input id="cityFilter" type="text" placeholder="e.g. Baku">
        </div>
        <div class="filter-actions">
            <button id="applyFilters" class="btn small">Show listings</button>
            <button id="resetFilters" class="btn small ghost">Reset</button>
        </div>
    </div>
</section>

<div class="carFlex" id="carFlex">
    {% for car in cars %}
    <a href="/details/{{ car.id }}" class="carCard">
        <div class="card" data-brand="{{ car.brand|lower }}" data-price="{{ car.price }}"
            data-city="{{ car.city|lower }}" data-currency="{{ car.currency }}">
            <img src="{{ car.images[0] }}" alt="{{ car.brand }} {{ car.model }}"
                onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
            <div class="card-content">
                <!-- Favorites Logic - Top Right -->
                <div class="card-like-btn">
                    {% if car.id is number %}
                    <!-- User Car: Functional Favorite -->
                    {% if current_user.is_authenticated %}
                    <form action="{{ url_for('toggle_favorite', car_id=car.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="like-btn" title="Add to Favorites">
                            <i class="{{ 'fa-solid' if car.id in fav_ids else 'fa-regular' }} fa-heart"></i>
                        </button>
                    </form>
                    {% endif %}
                    {% else %}
                    <!-- Demo Car: Visual Only (Non-functional) -->
                    <button class="like-btn" disabled title="Demo cars cannot be favorited">
                        <i class="fa-regular fa-heart"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="card-cta">
                    <p class="price">{{ car.price }}</p>
                    <span class="card-curr">{{ car.currency }}</span>
                </div>
                <div class="title">{{ car.brand }} {{ car.model }}</div>
                <div class="info">
                    <p>{{ car.year }} ‚Ä¢ {{ car.engine }}L ‚Ä¢ {{ car.odometer }} km</p>
                    <p style="margin-top: 10px;">üëÅÔ∏è {{
                        car.views|default(0)
                        }}</p>
                </div>
                <div class="location">{{ car.city }} ‚Ä¢ {{ car.dates }}</div>
                <div class="location" style="color: purple; margin: 15px 0;">Seller: {{ car.owner.username if car.owner
                    else 'Official' }}</div>
                <a href="/details/{{ car.id }}" class="btn">View Details</a>
            </div>
        </div>
    </a>
    {% endfor %}
</div>

<div class="load-more-container">
    <button id="loadMoreBtn" class="btn secondary ghost">Load More</button>
</div>

<!-- Auth modal (Optional: Keep it if you still want a popup version, but we have dedicated pages now) -->
<div class="modal" id="authModal">
    <div class="modal-content">
        <button class="close" data-close="authModal">&times;</button>
        <h2 id="authTitle">Login</h2>
        <form id="authForm">
            <div class="form-row">
                <label>Email</label>
                <input name="email" type="email" required>
            </div>
            <div class="form-row">
                <label>Password</label>
                <input name="password" type="password" required>
            </div>
            <button type="submit" class="btn full" id="authSubmit">Login (demo)</button>
        </form>
    </div>
</div>
{% endblock %}